using Autodesk.AutoCAD.ApplicationServices.Core;
using Autodesk.AutoCAD.DatabaseServices;
using Autodesk.AutoCAD.EditorInput;
using Autodesk.AutoCAD.Runtime;
using Newtonsoft.Json;
using System.IO;

[assembly: CommandClass(typeof(Autodesk.Forge.Sample.DesignAutomation.AutoCAD.MainEntry))]
[assembly: ExtensionApplication(null)]

namespace Autodesk.Forge.Sample.DesignAutomation.AutoCAD
{
  public class MainEntry
  {
    [CommandMethod("UpdateParam", CommandFlags.Modal)]
    public static void UpdateParam()
    {
      //Get active document of drawing with Dynamic block
      var doc = Application.DocumentManager.MdiActiveDocument;
      var db = doc.Database;

      // read input parameters from JSON file
      InputParams inputParams = JsonConvert.DeserializeObject<InputParams>(File.ReadAllText("params.json"));

      using (Transaction t = db.TransactionManager.StartTransaction())
      {
        var bt = t.GetObject(db.BlockTableId, OpenMode.ForRead) as BlockTable;

        foreach (ObjectId btrId in bt)
        {
          //get the blockDef and check if is anonymous
          BlockTableRecord btr = (BlockTableRecord)t.GetObject(btrId, OpenMode.ForRead);
          if (btr.IsDynamicBlock)
          {
            //get all anonymous blocks from this dynamic block
            ObjectIdCollection anonymousIds = btr.GetAnonymousBlockIds();
            ObjectIdCollection dynBlockRefs = new ObjectIdCollection();
            foreach (ObjectId anonymousBtrId in anonymousIds)
            {
              //get the anonymous block
              BlockTableRecord anonymousBtr = (BlockTableRecord)t.GetObject(anonymousBtrId, OpenMode.ForRead);
              //and all references to this block
              ObjectIdCollection blockRefIds = anonymousBtr.GetBlockReferenceIds(true, true);
              foreach (ObjectId id in blockRefIds)
              {
                dynBlockRefs.Add(id);
              }

            }
            if (dynBlockRefs.Count > 0)
            {
              //Get the first dynamic block reference, we have only one Dyanmic Block reference in Drawing
              var dBref = t.GetObject(dynBlockRefs[0], OpenMode.ForWrite) as BlockReference;
              UpdateDynamicProperties(dBref, inputParams);
            }
          }
        }
        t.Commit();
      }
      db.SaveAs("outputFile.dwg", DwgVersion.Current);
    }

    /// <summary>
    /// This updates the Dyanmic Blockreference with given Width and Height
    /// The initial parameters of Dynamic Blockrefence, Width =20.00 and Height =40.00
    /// </summary>
    /// <param Editor="ed"></param>
    /// <param BlockReference="br"></param>
    /// <param String="name"></param>
    private static void UpdateDynamicProperties(BlockReference br, InputParams inputParams)
    {
      // Only continue is we have a valid dynamic block
      if (br != null && br.IsDynamicBlock)
      {
        // Get the dynamic block's property collection
        DynamicBlockReferencePropertyCollection pc = br.DynamicBlockReferencePropertyCollection;
        foreach (DynamicBlockReferenceProperty prop in pc)
        {
          switch (prop.PropertyName)
          {
            case "Width":
              prop.Value = inputParams.Width;
              break;
            case "Height":
              prop.Value = inputParams.Height;
              break;
            default:
              break;
          }
        }
      }
    }
  }

  public class InputParams
  {
    public double Width { get; set; }
    public double Height { get; set; }
  }
}


